<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AARC Scanner</title>
</head>
<body style="background-color:black;color:white;">
<div id="logo">
    <img src="images/aarc-aurebesh.jpg" alt="AARC Logo" style="max-width: 100%;">
</div>
<img id="contents-image" src="images/aarc.jpg" alt="Crate Contents" style="max-width: 100%;display:none;">
<h1 id="results-header" style="display:none;text-align:center;padding-top:70px;padding-bottom:70px">None</h1>
<div id="qr-reader" style="width:500px"></div>
<div id="scanned" style="display: none;">
    <ul id="scanned-list">
    </ul>
</div>
<button id="start-button" style="font-size:36px;width:100%;background-color:white;color:black;padding:36px;">Scan</button>
<br>
<button id="stop-button" style="font-size:36px;width:100%;background-color:white;color:black;padding:36px;">Stop</button>
<br>
<button id="scanned-button" style="font-size:36px;width:100%;background-color:white;color:black;padding:36px;">Cargo Hold</button>
<br>


<script src="https://unpkg.com/html5-qrcode"></script>
<script type="module">
    import { CrateDecoder, CrateContents, CrateType } from "./crate-decoder.js";

    function docReady(fn) {
        // see if DOM is already available
        if (document.readyState === "complete"
            || document.readyState === "interactive") {
            // call on next available tick
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    //read parameters from the url
    const queryString = window.location.search;
    console.log(queryString);
    const urlParams = new URLSearchParams(queryString);

    const logo = document.getElementById('logo');
    const resultsHeader = document.getElementById('results-header');
    const contentsImage = document.getElementById('contents-image');
    let scanned = document.getElementById('scanned');

    //Keep track of the crates scanned so far and don't allow duplicates
    let scannedCrates = new Set();

    const crateDecoder = new CrateDecoder();

    //Add custom overrides
    crateDecoder.override(new CrateContents({code: 'JK_RS', contents: 'Evan\'s Manifesto', type: CrateType.Program, image: 'images/halcyon_cargo.jpeg'}));
    crateDecoder.override(new CrateContents({code: 'JK_TU', contents: 'Tom\'s Vape Pen', type: CrateType.Parts_and_Scraps, image: 'images/ports_of_call.jpeg'}));

    function addToScanned(code) {
        //add the item to the scannedCrates internal tracking
        scannedCrates.add(code);

        //add the item to the scanned list
        let scannedListItem = document.createElement('li');
        scannedListItem.style.fontSize = '72px';
        let scannedImage = document.createElement('img');
        scannedImage.style.maxWidth = '150px';
        let crate = crateDecoder.decode(code);
        scannedImage.src = crate.image;
        scannedListItem.appendChild(scannedImage);
        scannedListItem.appendChild(document.createTextNode("  " + crate.contents));
        scanned.appendChild(scannedListItem);

        //store all of the scanned crates into local storage
        localStorage.setItem('cargo', JSON.stringify(Array.from(scannedCrates)));
    }

    //load from local storage
    scannedCrates = new Set(JSON.parse(localStorage.getItem('cargo')));
    console.log("SCANNED CRATES");
    console.log(scannedCrates);
    if (scannedCrates && scannedCrates.size > 0) {
        const previousCrates = scannedCrates.entries();
        for (const crate of previousCrates) {
            console.log(crate);
            addToScanned(crate[0]);
        }
    } else {
        scannedCrates = new Set();
    }

    if (urlParams.has('reset')) {
        localStorage.removeItem('cargo');
        scannedCrates.clear();
        scanned = document.createElement('ul');
    }

    //use the url with ?cargo to load test data into the app
    if (urlParams.has('cargo')) {
        addToScanned('FAL11');
        addToScanned('CD_LM');
        addToScanned('JK_TU');
        addToScanned('AB_QR');
        addToScanned('JK_RS');

        //store all of the scanned crates into local storage
        localStorage.setItem('cargo', JSON.stringify(Array.from(scannedCrates)));
    }

    function setResult(code) {
        console.log(code);
        //update the display text for the item
        let crate = crateDecoder.decode(code);
        console.log(crate);
        resultsHeader.textContent = code + " - " + crate.contents;
        resultsHeader.style.display = 'block';

        //display the image contents
        contentsImage.style.display = 'block';
        contentsImage.src = crate.image;

        //add the item to the scanned list if not previously scanned
        if (!scannedCrates.has(code)) {
            addToScanned(code);
        }
    }

    // ####### Web Cam Scanning #######

    let config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        rememberLastUsedCamera: true,
        // Only support camera scan type.
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
        formatsToSupport: [ Html5QrcodeSupportedFormats.AZTEC ],
    };

    var html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", config);

    const updateFlashAvailability = () => {
        scanner.hasFlash().then(hasFlash => {
            flashToggle.style.display = hasFlash ? 'inline-block' : 'none';
        });
    };

    document.getElementById('start-button').addEventListener('click', () => {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        scanned.style.display = 'none';
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result ${decodedText}`, decodedResult);
            setResult(decodedText);
            html5QrcodeScanner.clear();
        }
        html5QrcodeScanner.render(onScanSuccess);
    });

    document.getElementById('stop-button').addEventListener('click', () => {
        logo.style.display = 'block';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        scanned.style.display = 'none';
        html5QrcodeScanner.clear();
    });

    document.getElementById('scanned-button').addEventListener('click', () => {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        scanned.style.display = 'block';
        html5QrcodeScanner.clear();
    });
</script>

<style>
    div {
        margin-bottom: 16px;
    }

    hr {
        margin-top: 32px;
    }
</style>
</body>
</html>
