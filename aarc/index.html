<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AARC Scanner</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<div id="logo">
    <img id="logo-image" src="images/aarc-aurebesh.jpg" alt="AARC Logo">
</div>
<img id="contents-image" src="images/aarc.jpg" alt="Crate Contents">
<h1 id="results-header">None</h1>
<div id="qr-reader"></div>
<div id="cargo-hold">
    <ul id="cargo-hold-list">
    </ul>
</div>
<button id="start-button" class="major-button">Scan</button>
<br>
<button id="stop-button" class="major-button">Stop</button>
<br>
<button id="scanned-button" class="major-button">Cargo Hold</button>
<br>


<script src="https://unpkg.com/html5-qrcode"></script>
<script type="module">
    import { CrateDecoder, CrateContents, CrateType } from "./crate-decoder.js";

    function docReady(fn) {
        // see if DOM is already available
        if (document.readyState === "complete"
            || document.readyState === "interactive") {
            // call on next available tick
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    //read parameters from the url
    const queryString = window.location.search;
    console.log(queryString);
    const urlParams = new URLSearchParams(queryString);

    const logo = document.getElementById('logo');
    const resultsHeader = document.getElementById('results-header');
    const contentsImage = document.getElementById('contents-image');
    const cargoHold = document.getElementById('cargo-hold');
    const cargoHoldList = document.getElementById('cargo-hold-list');

    //Keep track of the crates scanned so far and don't allow duplicates
    let scannedCrates = new Set();

    const crateDecoder = new CrateDecoder();

    //Add custom overrides
    crateDecoder.override(new CrateContents({code: 'JK_RS', contents: 'Evan\'s Manifesto', type: CrateType.Program, image: 'images/halcyon_cargo.jpeg'}));
    crateDecoder.override(new CrateContents({code: 'JK_TU', contents: 'Tom\'s Vape Pen', type: CrateType.Parts_and_Scraps, image: 'images/ports_of_call.jpeg'}));

    function displayCargoHold() {
        console.log('Building the cargo hold display');
        //clear list
        //cargoHoldList = document.createElement('ul');
        //cargoHoldList.id = 'cargo-hold-list';
        const newCargoHoldList = [];

        for (const cargoCode of scannedCrates) {
            console.log(`Creating the list item for ${cargoCode}`);
            const crate = crateDecoder.decode(cargoCode);

            //load the image
            const scannedImage = document.createElement('img');
            scannedImage.className = "scanned-list-item-image";
            scannedImage.src = crate.image;

            //add the item to the scanned list
            const scannedListItem = document.createElement('li');
            scannedListItem.className = "scanned-list-item-text";
            scannedListItem.appendChild(scannedImage);
            scannedListItem.appendChild(document.createTextNode("  " + crate.contents));

            newCargoHoldList.push(scannedListItem);
        }

        cargoHoldList.replaceChildren(...newCargoHoldList);
    }

    function addToScanned(code) {
        console.log(`Adding ${code} to the scanned list`);
        //add the item to the scannedCrates internal tracking
        scannedCrates.add(code);

        //store all of the scanned crates into local storage
        localStorage.setItem('cargo', JSON.stringify(Array.from(scannedCrates)));
    }

    //load from local storage
    scannedCrates = new Set(JSON.parse(localStorage.getItem('cargo')));
    console.log("SCANNED CRATES");
    console.log(scannedCrates);
    if (scannedCrates && scannedCrates.size > 0) {
        const previousCrates = scannedCrates.entries();
        for (const crate of previousCrates) {
            console.log(crate);
            addToScanned(crate[0]);
        }
    } else {
        scannedCrates = new Set();
    }

    if (urlParams.has('reset')) {
        localStorage.removeItem('cargo');
        scannedCrates.clear();
    }

    //use the url with ?cargo to load test data into the app
    if (urlParams.has('cargo')) {
        console.log("Filling the cargo hold...");
        addToScanned('FAL11');
        addToScanned('CD_LM');
        addToScanned('JK_TU');
        addToScanned('AB_QR');
        addToScanned('JK_RS');

        //store all of the scanned crates into local storage
        localStorage.setItem('cargo', JSON.stringify(Array.from(scannedCrates)));
    }

    function setResult(code) {
        console.log(code);
        //update the display text for the item
        let crate = crateDecoder.decode(code);
        console.log(crate);
        resultsHeader.textContent = code + " - " + crate.contents;
        resultsHeader.style.display = 'block';

        //display the image contents
        contentsImage.style.display = 'block';
        contentsImage.src = crate.image;

        //add the item to the scanned list if not previously scanned
        if (!scannedCrates.has(code)) {
            addToScanned(code);
        }
    }

    // ####### Web Cam Scanning #######

    let config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        rememberLastUsedCamera: true,
        // Only support camera scan type.
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
        formatsToSupport: [ Html5QrcodeSupportedFormats.AZTEC ],
    };

    var html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", config);

    const updateFlashAvailability = () => {
        scanner.hasFlash().then(hasFlash => {
            flashToggle.style.display = hasFlash ? 'inline-block' : 'none';
        });
    };

    document.getElementById('start-button').addEventListener('click', () => {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        cargoHold.style.display = 'none';
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result ${decodedText}`, decodedResult);
            setResult(decodedText);
            html5QrcodeScanner.clear();
        }
        html5QrcodeScanner.render(onScanSuccess);
    });

    document.getElementById('stop-button').addEventListener('click', () => {
        logo.style.display = 'block';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        cargoHold.style.display = 'none';
        html5QrcodeScanner.clear();
    });

    document.getElementById('scanned-button').addEventListener('click', () => {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        displayCargoHold();
        cargoHold.style.display = 'block';
        html5QrcodeScanner.clear();
    });
</script>
</body>
</html>
