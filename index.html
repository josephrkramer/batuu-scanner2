<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AARC Scanner</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <link rel="stylesheet" type="text/css" href="./puzzle/15-puzzle.css">
</head>
<body>
<div id="logo">
    <img id="logo-image" src="images/aarc-aurebesh.jpg" alt="AARC Logo">
</div>
<img id="contents-image" src="images/aarc.jpg" alt="Crate Contents">
<h1 id="results-header">None</h1>
<div id="qr-reader"></div>
<div id="cargo-hold">
    <h1 id="cargo-hold-title">Cargo Hold</h1>
    <ul id="cargo-hold-list">
    </ul>
</div>
<div id="puzzle" style="display:none"></div>
<button id="start-button" class="major-button">Scan</button>
<br>
<button id="stop-button" class="major-button">Stop</button>
<br>
<button id="scanned-button" class="major-button">Cargo Hold</button>
<br>


<script src="https://unpkg.com/html5-qrcode"></script>
<script src="./puzzle/15-puzzle.js"></script>
<script type="module">
    import { CrateDecoder, CrateContents, CrateType } from "./crate-decoder.js";

    function docReady(fn) {
        // see if DOM is already available
        if (document.readyState === "complete"
            || document.readyState === "interactive") {
            // call on next available tick
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    //read parameters from the url
    const queryString = window.location.search;
    console.log(queryString);
    const urlParams = new URLSearchParams(queryString);

    const logo = document.getElementById('logo');
    const resultsHeader = document.getElementById('results-header');
    const contentsImage = document.getElementById('contents-image');
    const cargoHold = document.getElementById('cargo-hold');
    const cargoHoldList = document.getElementById('cargo-hold-list');
    const puzzle = document.getElementById('puzzle');

    //Keep track of the crates scanned so far and don't allow duplicates
    //load from local storage
    const scannedCrates = new Set(JSON.parse(localStorage.getItem('cargo')));
    console.log(`Cargo hold instantiated from local storage:`);
    console.log(scannedCrates);

    const crateDecoder = new CrateDecoder();

    //Add custom overrides
    crateDecoder.override(new CrateContents({code: 'JK_RS', contents: 'Evan\'s Manifesto', type: CrateType.Relic, image: 'images/halcyon_cargo.jpeg'}));
    crateDecoder.override(new CrateContents({code: 'JK_TU', contents: 'Tom\'s Vape Pen', type: CrateType.Relic, image: 'images/ports_of_call.jpeg'}));

    function displayCargoHold() {
        console.log('Building the cargo hold display');
        const sortedCargoHold = crateDecoder.sortCargoHold(scannedCrates);
        const newCargoHoldList = [];

        for (const crateType of sortedCargoHold.keys()) {
            console.log(crateType);

            //create type list
            const crateTypeListItem = document.createElement('li');
            crateTypeListItem.className = "cargo-type-text";
            crateTypeListItem.appendChild(document.createTextNode(crateType));

            const crateTypeList = document.createElement('ul');
            crateTypeListItem.appendChild(crateTypeList);

            //populate type list with each instance of that type
            for (const crate of sortedCargoHold.get(crateType)) {
                //load the image
                const scannedImage = document.createElement('img');
                scannedImage.className = "scanned-list-item-image";
                scannedImage.src = crate.image;

                scannedImage.addEventListener('click', () => {
                    cargoHold.style.display = 'none';
                    setResult(crate.code);
                });

                //add the item to the scanned list
                const scannedListItem = document.createElement('li');
                scannedListItem.className = "scanned-list-item-text";
                scannedListItem.appendChild(scannedImage);
                scannedListItem.appendChild(document.createTextNode("  " + crate.contents));

                crateTypeList.appendChild(scannedListItem);
            }
            newCargoHoldList.push(crateTypeListItem);
        }

        cargoHoldList.replaceChildren(...newCargoHoldList);
    }

    function addToScanned(code) {
        console.log(`Adding ${code} to the scanned list`);
        //add the item to the scannedCrates internal tracking
        scannedCrates.add(code);

        //store all of the scanned crates into local storage
        localStorage.setItem('cargo', JSON.stringify(Array.from(scannedCrates)));
    }

    //use the url with ?cargo to load test data into the app
    if (urlParams.has('cargo')) {
        console.log("Filling the cargo hold...");
        addToScanned('FAL11');
        addToScanned('CD_LM');
        addToScanned('JK_TU');
        addToScanned('AB_QR');
        addToScanned('JK_RS');
    }

    if (urlParams.has('reset')) {
        //remove our state from local storage
        localStorage.removeItem('cargo');
        //remove our state from internal memory
        scannedCrates.clear();
        //force a reload of the page that will refresh the cache. Equivalent of Ctl+F5
        window.location.reload(true);
        //strip ?reset from the url so we don't get in a refresh loop
        window.location = window.location.pathname;
    }

    function setResult(code) {
        console.log(code);
        //update the display text for the item
        let crate = crateDecoder.decode(code);
        console.log(crate);
        resultsHeader.textContent = code + " - " + crate.contents;
        resultsHeader.style.display = 'block';

        //display the image contents
        contentsImage.style.display = 'block';
        contentsImage.src = crate.image;

        //add the item to the scanned list if not previously scanned
        if (!scannedCrates.has(code)) {
            addToScanned(code);
        }
    }

    // ####### Web Cam Scanning #######

    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        rememberLastUsedCamera: true,
        // Only support camera scan type.
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
        formatsToSupport: [ Html5QrcodeSupportedFormats.AZTEC ],
    };

    const html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", config);

    //allow direct access to the puzzle for testing
    if (urlParams.has('puzzle')) {
        console.log("Starting puzzle for testing");
        stopButton();
        logo.style.display = 'none';
        puzzle.style.display = 'block';
        //start puzzle and wait for success
        await waitToSolvePuzzle().then(
            function(value) {
                console.log("PUZZLE SUCESS");
                puzzle.style.display = 'none';
            },
            function(error) {
                console.log("PUZZLE FAILURE");
            }
        );
        stopButton();
    }
    
    function startButton() {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        cargoHold.style.display = 'none';
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result ${decodedText}`, decodedResult);
            puzzle.style.display = 'block';
            html5QrcodeScanner.clear();

            //start puzzle and wait for success
            waitToSolvePuzzle().then(
                function(value) {
                    console.log("PUZZLE SUCESS");
                    setResult(decodedText);
                    puzzle.style.display = 'none';
                },
                function(error) {
                    console.log("PUZZLE FAILURE");
                }
            );
        }
        html5QrcodeScanner.render(onScanSuccess);
        puzzle.style.display = 'none';
    }

    function stopButton() {
        logo.style.display = 'block';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        cargoHold.style.display = 'none';
        html5QrcodeScanner.clear();
        puzzle.style.display = 'none';
    }

    function cargoHoldButton() {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        displayCargoHold();
        cargoHold.style.display = 'block';
        html5QrcodeScanner.clear();
        puzzle.style.display = 'none';
    }

    document.getElementById('start-button').addEventListener('click', () => {
        startButton();
    });

    document.getElementById('stop-button').addEventListener('click', () => {
        stopButton();
    });

    document.getElementById('scanned-button').addEventListener('click', () => {
        cargoHoldButton();
    });
</script>
</body>
</html>
