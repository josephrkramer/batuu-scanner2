<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AARC Scanner</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <link rel="stylesheet" type="text/css" href="./puzzle/15-puzzle.css">
</head>
<body>
<div id="logo">
    <img id="logo-image" src="images/aarc-aurebesh.jpg" alt="AARC Logo">
</div>
<img id="contents-image" src="images/aarc.jpg" alt="Crate Contents">
<h1 id="results-header">None</h1>
<div id="qr-reader"></div>
<div id="cargo-hold">
    <h1 id="cargo-hold-title">Cargo Hold</h1>
    <ul id="cargo-hold-list">
    </ul>
</div>
<div id="crew-manifest">
    <h1 id="crew-manifest-title">Dossiers</h1>
    <ul id="crew-manifests-list">
    </ul>
</div>
<div id="crew-member">
    <img id="crew-member-picture" src="images/outfit.jpeg" alt="Crew Member">
    <h1 id="crew-member-name">Darth Plagueis the Wise</h1>
    <ul id="crew-member-details">
    </ul>
</div>
<div id="chain-code">
    <h1 id="chain-code-title">Chain Code Value</h1>
</div>
<div id="puzzle" style="display:none"></div>
<button id="start-button" class="major-button">Scan</button>
<br>
<button id="stop-button" class="major-button">Stop</button>
<br>
<button id="scanned-button" class="major-button">Cargo Hold</button>
<br>
<button id="crew-manifest-button" class="major-button">Dossiers</button>
<br>
<button id="decode-chain-code-button" class="major-button">Decode Chain Code</button>
<br>


<script src="https://unpkg.com/html5-qrcode"></script>
<script src="./puzzle/15-puzzle.js"></script>
<script type="module">
    import { CrateDecoder, CrateContents, CrateType } from "./crate-decoder.js";
    import { CrewMemberType, CrewMember, CrewManifest, displayCrewManifest } from "./crew-manifest.js";
    import { ChainCodeAlignment, ChainCodePart, ChainCodeDecoder } from "./chain-code.js";
    import { displayCargoHold } from "./cargo-hold.js";

    function docReady(fn) {
        // see if DOM is already available
        if (document.readyState === "complete"
            || document.readyState === "interactive") {
            // call on next available tick
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    //read parameters from the url
    const queryString = window.location.search;
    console.log(queryString);
    const urlParams = new URLSearchParams(queryString);

    const logo = document.getElementById('logo');
    const resultsHeader = document.getElementById('results-header');
    const contentsImage = document.getElementById('contents-image');
    const cargoHold = document.getElementById('cargo-hold');
    const puzzle = document.getElementById('puzzle');
    const crewManifest = document.getElementById('crew-manifest');
    const crewMemberDiv = document.getElementById('crew-member');
    const chainCodeDiv = document.getElementById('chain-code');

    const crateDecoder = new CrateDecoder();
    const crewMembers = new CrewManifest();
    const chainCodeDecoder = new ChainCodeDecoder();

    //Add custom overrides
    crateDecoder.override(new CrateContents({code: 'JK_RS', contents: 'Evan\'s Manifesto', type: CrateType.Relic, image: 'images/halcyon_cargo.jpeg'}));
    crateDecoder.override(new CrateContents({code: 'JK_TU', contents: 'Tom\'s Vape Pen', type: CrateType.Relic, image: 'images/ports_of_call.jpeg'}));

    //Keep track of the crates scanned so far and don't allow duplicates
    //load from local storage
    const scannedCrates = new Set(JSON.parse(localStorage.getItem('cargo')));
    console.log(`Cargo hold instantiated from local storage:`);
    console.log(scannedCrates);

    //load chainCode from local storage
    const chainCode = localStorage.chainCode !== undefined ? JSON.parse(localStorage.chainCode) : new Array();
    console.log(`Chain code instantiated from local storage:`);
    console.log(chainCode);
    //check if the decode button should be enabled after an initial load from local storage
    checkDecodeButton();

    function checkDecodeButton() {
        console.log(`Chain code length: ${chainCode.length}`);
        if (chainCode.length >= chainCodeDecoder.MIN_CHAIN_CODE_SIZE) {
            const decodeButton = document.getElementById('decode-chain-code-button');
            decodeButton.style.display = 'block';
        }
    }

    function addToScanned(code) {
        console.log(`Adding ${code} to the scanned list`);
        //add the item to the scannedCrates internal tracking
        scannedCrates.add(code);

        //store all of the scanned crates into local storage
        localStorage.setItem('cargo', JSON.stringify(Array.from(scannedCrates)));
    }

    //use the url with ?cargo to load test data into the app
    if (urlParams.has('cargo')) {
        console.log("Filling the cargo hold...");
        addToScanned('FAL11');
        addToScanned('CD_LM');
        addToScanned('JK_TU');
        addToScanned('AB_QR');
        addToScanned('JK_RS');
    }

    if (urlParams.has('reset')) {
        //remove our state from local storage
        localStorage.removeItem('cargo');
        localStorage.removeItem('chainCode');
        //remove our state from internal memory
        scannedCrates.clear();
        chainCode.splice(0, chainCode.length);

        //force a reload of the page that will refresh the cache. Equivalent of Ctl+F5
        window.location.reload(true);
        //strip ?reset from the url so we don't get in a refresh loop
        window.location = window.location.pathname;
    }

    function setResult(code) {
        console.log(code);
        //update the display text for the item
        const crate = crateDecoder.decode(code);
        console.log(crate);
        if (urlParams.has('debug')) {
            resultsHeader.textContent = code + " - " + crate.contents;
        } else {
            resultsHeader.textContent = crate.contents;
        }
        resultsHeader.style.display = 'block';

        //display the image contents
        contentsImage.style.display = 'block';
        contentsImage.src = crate.image;

        //add the item to the scanned list if not previously scanned
        if (!scannedCrates.has(code)) {
            addToScanned(code);
        }
    }

    // ####### Web Cam Scanning #######

    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        rememberLastUsedCamera: true,
        // Only support camera scan type.
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
        formatsToSupport: [ Html5QrcodeSupportedFormats.AZTEC ],
    };

    const html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", config);

    //allow direct access to the puzzle for testing
    if (urlParams.has('puzzle')) {
        console.log("Starting puzzle for testing");
        stopButton();
        logo.style.display = 'none';
        puzzle.style.display = 'block';
        //start puzzle and wait for success
        await waitToSolvePuzzle().then(
            function(value) {
                console.log("PUZZLE SUCCESS");
                puzzle.style.display = 'none';
            },
            function(error) {
                console.log("PUZZLE FAILURE");
            }
        );
        stopButton();
    }

    function displayChainCodeResult(chainCodePart) {
        //update the display text for the item
        console.log(chainCodePart);
        if (urlParams.has('debug')) {
            resultsHeader.textContent = chainCodePart.code + " - Chain Code Piece";
        } else {
            resultsHeader.textContent = "Chain Code Piece";
        }
        resultsHeader.style.display = 'block';

        //display the image contents
        contentsImage.style.display = 'block';
        contentsImage.src = chainCodePart.image;
    }
    
    function setChainCodeResult(code) {
        console.log(`Valid Chain Code Detected: ${code}`);
        const chainCodePart = chainCodeDecoder.decode(code);

        displayChainCodeResult(chainCodePart);

        //add the item to the chainCode internal tracking
        chainCode.push(code);

        //store all of the scanned crates into local storage
        localStorage.chainCode = JSON.stringify(chainCode);

        checkDecodeButton();
    }

    function setChainCodeValue() {
        const chainCodeHeader = document.getElementById('chain-code-title');
        chainCodeHeader.textContent = "Chain Code Value: " + chainCodeDecoder.rawValue(chainCode);
    }
    
    function startButton() {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        cargoHold.style.display = 'none';
        crewManifest.style.display = 'none';
        crewMemberDiv.style.display = 'none';
        chainCodeDiv.style.display = 'none';

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result ${decodedText}`, decodedResult);
            html5QrcodeScanner.clear();

            const crate = crateDecoder.decode(decodedText);

            if (chainCodeDecoder.isValidChainCode(decodedText) || crate.type == CrateType.Unknown || urlParams.has('debug')) {
                if (chainCodeDecoder.isValidChainCode(decodedText)) {
                    setChainCodeResult(decodedText);
                } else {
                    setResult(decodedText);
                }
            } else {
                //start puzzle and wait for success
                puzzle.style.display = 'block';
                waitToSolvePuzzle().then(
                    function(value) {
                        console.log("PUZZLE SUCCESS");
                        setResult(decodedText);
                        puzzle.style.display = 'none';
                    },
                    function(error) {
                        console.log("PUZZLE FAILURE");
                    }
                );
            }
        }
        html5QrcodeScanner.render(onScanSuccess);
        puzzle.style.display = 'none';
    }

    function stopButton() {
        logo.style.display = 'block';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        cargoHold.style.display = 'none';
        html5QrcodeScanner.clear();
        puzzle.style.display = 'none';
        crewManifest.style.display = 'none';
        crewMemberDiv.style.display = 'none';
        chainCodeDiv.style.display = 'none';
    }

    function cargoHoldButton() {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        displayCargoHold(crateDecoder, scannedCrates, chainCode, chainCodeDecoder);
        cargoHold.style.display = 'block';
        html5QrcodeScanner.clear();
        puzzle.style.display = 'none';
        crewManifest.style.display = 'none';
        crewMemberDiv.style.display = 'none';
        chainCodeDiv.style.display = 'none';
    }

    function crewManifestButton() {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        cargoHold.style.display = 'none';
        html5QrcodeScanner.clear();
        puzzle.style.display = 'none';
        crewManifest.style.display = 'block';
        crewMemberDiv.style.display = 'none';
        displayCrewManifest(crewMembers);
        chainCodeDiv.style.display = 'none';
    }

    function decodeChainCodeButton() {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        cargoHold.style.display = 'none';
        html5QrcodeScanner.clear();
        puzzle.style.display = 'none';
        crewManifest.style.display = 'none';
        crewMemberDiv.style.display = 'none';
        chainCodeDiv.style.display = 'block';
        setChainCodeValue();
    }

    document.getElementById('start-button').addEventListener('click', () => {
        startButton();
    });

    document.getElementById('stop-button').addEventListener('click', () => {
        stopButton();
    });

    document.getElementById('scanned-button').addEventListener('click', () => {
        cargoHoldButton();
    });

    document.getElementById('crew-manifest-button').addEventListener('click', () => {
        crewManifestButton();
    });

    document.getElementById('decode-chain-code-button').addEventListener('click', () => {
        decodeChainCodeButton();
    });
</script>
</body>
</html>
