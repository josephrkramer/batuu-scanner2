<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AARC Scanner</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <link rel="stylesheet" type="text/css" href="./puzzle/15-puzzle.css">
</head>
<body>
<div id="logo">
    <img id="logo-image" src="images/aarc-aurebesh.jpg" alt="AARC Logo">
</div>
<img id="contents-image" src="images/aarc.jpg" alt="Crate Contents">
<h1 id="results-header">None</h1>
<div id="qr-reader"></div>
<div id="cargo-hold">
    <h1 id="cargo-hold-title">Cargo Hold</h1>
    <ul id="cargo-hold-list">
    </ul>
</div>
<div id="crew-manifest">
    <h1 id="crew-manifest-title">Dossiers</h1>
    <ul id="crew-manifests-list">
    </ul>
</div>
<div id="crew-member">
    <img id="crew-member-picture" src="images/outfit.jpeg" alt="Crew Member">
    <h1 id="crew-member-name">Darth Plagueis the Wise</h1>
    <ul id="crew-member-details">
    </ul>
</div>
<div id="puzzle" style="display:none"></div>
<button id="start-button" class="major-button">Scan</button>
<br>
<button id="stop-button" class="major-button">Stop</button>
<br>
<button id="scanned-button" class="major-button">Cargo Hold</button>
<br>
<button id="crew-manifest-button" class="major-button">Dossiers</button>
<br>
<button id="decode-chain-code-button" class="major-button">Decode Chain Code</button>
<br>


<script src="https://unpkg.com/html5-qrcode"></script>
<script src="./puzzle/15-puzzle.js"></script>
<script type="module">
    import { CrateDecoder, CrateContents, CrateType } from "./crate-decoder.js";
    import { CrewMemberType, CrewMember, CrewManifest } from "./crew-manifest.js";
    import { ChainCodeAlignment, ChainCodePart, ChainCodeDecoder } from "./chain-code.js";

    function docReady(fn) {
        // see if DOM is already available
        if (document.readyState === "complete"
            || document.readyState === "interactive") {
            // call on next available tick
            setTimeout(fn, 1);
        } else {
            document.addEventListener("DOMContentLoaded", fn);
        }
    }

    //read parameters from the url
    const queryString = window.location.search;
    console.log(queryString);
    const urlParams = new URLSearchParams(queryString);

    const logo = document.getElementById('logo');
    const resultsHeader = document.getElementById('results-header');
    const contentsImage = document.getElementById('contents-image');
    const cargoHold = document.getElementById('cargo-hold');
    const cargoHoldList = document.getElementById('cargo-hold-list');
    const puzzle = document.getElementById('puzzle');
    const crewManifest = document.getElementById('crew-manifest');
    const crewManifestList = document.getElementById('crew-manifests-list');
    const crewMemberDiv = document.getElementById('crew-member');

    const crateDecoder = new CrateDecoder();
    const crewMembers = new CrewManifest();
    const chainCodeDecoder = new ChainCodeDecoder();

    //Add custom overrides
    crateDecoder.override(new CrateContents({code: 'JK_RS', contents: 'Evan\'s Manifesto', type: CrateType.Relic, image: 'images/halcyon_cargo.jpeg'}));
    crateDecoder.override(new CrateContents({code: 'JK_TU', contents: 'Tom\'s Vape Pen', type: CrateType.Relic, image: 'images/ports_of_call.jpeg'}));

    //Keep track of the crates scanned so far and don't allow duplicates
    //load from local storage
    const scannedCrates = new Set(JSON.parse(localStorage.getItem('cargo')));
    console.log(`Cargo hold instantiated from local storage:`);
    console.log(scannedCrates);

    //load chainCode from local storage
    const chainCode = localStorage.chainCode !== undefined ? JSON.parse(localStorage.chainCode) : new Array();
    console.log(`Chain code instantiated from local storage:`);
    console.log(chainCode);
    //check if the decode button should be enabled after an initial load from local storage
    checkDecodeButton();

    function checkDecodeButton() {
        console.log(`Chain code length: ${chainCode.length}`);
        if (chainCode.length >= chainCodeDecoder.MIN_CHAIN_CODE_SIZE) {
            const decodeButton = document.getElementById('decode-chain-code-button');
            decodeButton.style.display = 'block';
        }
    }

    function displayCargoHold() {
        console.log('Building the cargo hold display');
        const sortedCargoHold = crateDecoder.sortCargoHold(scannedCrates);
        const newCargoHoldList = [];

        for (const crateType of sortedCargoHold.keys()) {
            console.log(crateType);

            //create type list
            const crateTypeListItem = document.createElement('li');
            crateTypeListItem.className = "cargo-type-text";
            crateTypeListItem.appendChild(document.createTextNode(crateType));

            const crateTypeList = document.createElement('ul');
            crateTypeListItem.appendChild(crateTypeList);

            //populate type list with each instance of that type
            for (const crate of sortedCargoHold.get(crateType)) {
                //load the image
                const scannedImage = document.createElement('img');
                scannedImage.className = "scanned-list-item-image";
                scannedImage.src = crate.image;

                scannedImage.addEventListener('click', () => {
                    cargoHold.style.display = 'none';
                    setResult(crate.code);
                });

                //add the item to the scanned list
                const scannedListItem = document.createElement('li');
                scannedListItem.className = "scanned-list-item-text";
                scannedListItem.appendChild(scannedImage);
                scannedListItem.appendChild(document.createTextNode("  " + crate.contents));

                crateTypeList.appendChild(scannedListItem);
            }
            newCargoHoldList.push(crateTypeListItem);
        }

        if (chainCode.length > 0) {
            //add chain code
            const chainCodeListItem = document.createElement('li');
            chainCodeListItem.className = "cargo-type-text";
            chainCodeListItem.appendChild(document.createTextNode("Chain Code"));
            const chainCodeList = document.createElement('ul');
            chainCodeListItem.appendChild(chainCodeList);
            for (const code of chainCode) {
                const chainCodePart = chainCodeDecoder.decode(code);
                const scannedImage = document.createElement('img');
                scannedImage.className = "scanned-list-item-image";
                scannedImage.src = chainCodePart.image;

                scannedImage.addEventListener('click', () => {
                    cargoHold.style.display = 'none';
                    displayChainCodeResult(chainCodePart);
                });

                //add the item to the scanned list
                const scannedListItem = document.createElement('li');
                scannedListItem.className = "scanned-list-item-text";
                scannedListItem.appendChild(scannedImage);
                if (urlParams.has('debug')) {
                    scannedListItem.appendChild(document.createTextNode("  " + chainCodePart.code + " - Chain Code Piece"));
                } else {
                    scannedListItem.appendChild(document.createTextNode("  Chain Code Piece"));
                }

                chainCodeList.appendChild(scannedListItem);
            }
            newCargoHoldList.push(chainCodeListItem);
        }

        cargoHoldList.replaceChildren(...newCargoHoldList);
    }

    function displayCrewManifest() {
        console.log('Building the crew manifest display');
        const crewMemberTypesToSort = [CrewMemberType.Faction_Leader, CrewMemberType.NPC];
        const newCrewManifestList = [];

        for (const crewType of crewMemberTypesToSort) {
            console.log(crewType);

            //create type list
            const crewTypeListItem = document.createElement('li');
            crewTypeListItem.className = "cargo-type-text";
            crewTypeListItem.appendChild(document.createTextNode(crewType));

            const crewTypeList = document.createElement('ul');
            crewTypeListItem.appendChild(crewTypeList);

            //populate type list with each instance of that type
            for (const crewMember of crewMembers.get(crewType)) {
                console.log(crewMember)
                //load the image
                const crewMemberHeadshot = document.createElement('img');
                crewMemberHeadshot.className = "scanned-list-item-image";
                crewMemberHeadshot.src = crewMember.image;

                crewMemberHeadshot.addEventListener('click', () => {
                    crewManifest.style.display = 'none';
                    crewMemberDiv.style.display = 'block';

                    const crewMemberPicture = document.getElementById('crew-member-picture');
                    const crewMemberName = document.getElementById('crew-member-name');
                    const crewMemberDetails = document.getElementById('crew-member-details');
                    const crewMemberDetailsListItems = [];

                    //fill in the details
                    crewMemberName.textContent = crewMember.name;
                    crewMemberPicture.src = crewMember.image;

                    function createCrewMemberListItem(text, content) {
                        if (content !== undefined){
                            const crewMemberListItem = document.createElement('li');
                            crewMemberListItem.className = "scanned-list-item-text multi-line";
                            crewMemberListItem.textContent = `${text}: ` + content;
                            crewMemberDetailsListItems.push(crewMemberListItem);
                        }
                    }

                    createCrewMemberListItem('Occupation', crewMember.occupation);
                    createCrewMemberListItem('Affiliation', crewMember.affiliation);
                    createCrewMemberListItem('Homeworld', crewMember.homeworld);
                    createCrewMemberListItem('Companion', crewMember.companion);
                    createCrewMemberListItem('Vehicle', crewMember.vehicle);
                    createCrewMemberListItem('Species', crewMember.species);
                    createCrewMemberListItem('Biography', crewMember.biography);

                    crewMemberDetails.replaceChildren(...crewMemberDetailsListItems);
                });

                //add the item to the scanned list
                const crewMemberListItem = document.createElement('li');
                crewMemberListItem.className = "scanned-list-item-text";
                crewMemberListItem.appendChild(crewMemberHeadshot);
                crewMemberListItem.appendChild(document.createTextNode("  " + crewMember.name));

                crewTypeList.appendChild(crewMemberListItem);
            }
            newCrewManifestList.push(crewTypeListItem);
        }

        crewManifestList.replaceChildren(...newCrewManifestList);
    }

    function addToScanned(code) {
        console.log(`Adding ${code} to the scanned list`);
        //add the item to the scannedCrates internal tracking
        scannedCrates.add(code);

        //store all of the scanned crates into local storage
        localStorage.setItem('cargo', JSON.stringify(Array.from(scannedCrates)));
    }

    //use the url with ?cargo to load test data into the app
    if (urlParams.has('cargo')) {
        console.log("Filling the cargo hold...");
        addToScanned('FAL11');
        addToScanned('CD_LM');
        addToScanned('JK_TU');
        addToScanned('AB_QR');
        addToScanned('JK_RS');
    }

    if (urlParams.has('reset')) {
        //remove our state from local storage
        localStorage.removeItem('cargo');
        localStorage.removeItem('chainCode');
        //remove our state from internal memory
        scannedCrates.clear();
        chainCode.splice(0, chainCode.length);

        //force a reload of the page that will refresh the cache. Equivalent of Ctl+F5
        window.location.reload(true);
        //strip ?reset from the url so we don't get in a refresh loop
        window.location = window.location.pathname;
    }

    function setResult(code) {
        console.log(code);
        //update the display text for the item
        const crate = crateDecoder.decode(code);
        console.log(crate);
        if (urlParams.has('debug')) {
            resultsHeader.textContent = code + " - " + crate.contents;
        } else {
            resultsHeader.textContent = crate.contents;
        }
        resultsHeader.style.display = 'block';

        //display the image contents
        contentsImage.style.display = 'block';
        contentsImage.src = crate.image;

        //add the item to the scanned list if not previously scanned
        if (!scannedCrates.has(code)) {
            addToScanned(code);
        }
    }

    // ####### Web Cam Scanning #######

    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        rememberLastUsedCamera: true,
        // Only support camera scan type.
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
        formatsToSupport: [ Html5QrcodeSupportedFormats.AZTEC ],
    };

    const html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", config);

    //allow direct access to the puzzle for testing
    if (urlParams.has('puzzle')) {
        console.log("Starting puzzle for testing");
        stopButton();
        logo.style.display = 'none';
        puzzle.style.display = 'block';
        //start puzzle and wait for success
        await waitToSolvePuzzle().then(
            function(value) {
                console.log("PUZZLE SUCCESS");
                puzzle.style.display = 'none';
            },
            function(error) {
                console.log("PUZZLE FAILURE");
            }
        );
        stopButton();
    }

    function displayChainCodeResult(chainCodePart) {
        //update the display text for the item
        console.log(chainCodePart);
        if (urlParams.has('debug')) {
            resultsHeader.textContent = chainCodePart.code + " - Chain Code Piece";
        } else {
            resultsHeader.textContent = "Chain Code Piece";
        }
        resultsHeader.style.display = 'block';

        //display the image contents
        contentsImage.style.display = 'block';
        contentsImage.src = chainCodePart.image;
    }
    
    function setChainCodeResult(code) {
        console.log(`Valid Chain Code Detected: ${code}`);
        const chainCodePart = chainCodeDecoder.decode(code);

        displayChainCodeResult(chainCodePart);

        //add the item to the chainCode internal tracking
        chainCode.push(code);

        //store all of the scanned crates into local storage
        localStorage.chainCode = JSON.stringify(chainCode);

        checkDecodeButton();
    }
    
    function startButton() {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        cargoHold.style.display = 'none';
        crewManifest.style.display = 'none';
        crewMemberDiv.style.display = 'none';

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result ${decodedText}`, decodedResult);
            html5QrcodeScanner.clear();

            const crate = crateDecoder.decode(decodedText);

            if (chainCodeDecoder.isValidChainCode(decodedText) || crate.type == CrateType.Unknown || urlParams.has('debug')) {
                if (chainCodeDecoder.isValidChainCode(decodedText)) {
                    setChainCodeResult(decodedText);
                } else {
                    setResult(decodedText);
                }
            } else {
                //start puzzle and wait for success
                puzzle.style.display = 'block';
                waitToSolvePuzzle().then(
                    function(value) {
                        console.log("PUZZLE SUCCESS");
                        setResult(decodedText);
                        puzzle.style.display = 'none';
                    },
                    function(error) {
                        console.log("PUZZLE FAILURE");
                    }
                );
            }
        }
        html5QrcodeScanner.render(onScanSuccess);
        puzzle.style.display = 'none';
    }

    function stopButton() {
        logo.style.display = 'block';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        cargoHold.style.display = 'none';
        html5QrcodeScanner.clear();
        puzzle.style.display = 'none';
        crewManifest.style.display = 'none';
        crewMemberDiv.style.display = 'none';
    }

    function cargoHoldButton() {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        displayCargoHold();
        cargoHold.style.display = 'block';
        html5QrcodeScanner.clear();
        puzzle.style.display = 'none';
        crewManifest.style.display = 'none';
        crewMemberDiv.style.display = 'none';
    }

    function crewManifestButton() {
        logo.style.display = 'none';
        resultsHeader.style.display = 'none';
        contentsImage.style.display = 'none';
        cargoHold.style.display = 'none';
        html5QrcodeScanner.clear();
        puzzle.style.display = 'none';
        crewManifest.style.display = 'block';
        crewMemberDiv.style.display = 'none';
        displayCrewManifest();
    }

    document.getElementById('start-button').addEventListener('click', () => {
        startButton();
    });

    document.getElementById('stop-button').addEventListener('click', () => {
        stopButton();
    });

    document.getElementById('scanned-button').addEventListener('click', () => {
        cargoHoldButton();
    });

    document.getElementById('crew-manifest-button').addEventListener('click', () => {
        crewManifestButton();
    });
</script>
</body>
</html>
